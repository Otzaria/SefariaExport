name: Sefaria Export (Self-hosted runner, Docker Mongo, export_all_merged)

on:
  workflow_dispatch:
    inputs:
      timezone:
        description: "Timezone (IANA name)"
        required: false
        default: "Asia/Jerusalem"

permissions:
  contents: write

env:
  TZ_NAME: ${{ inputs.timezone || 'Asia/Jerusalem' }}
  DJANGO_SETTINGS_MODULE: sefaria.settings
  MONGO_HOST: 127.0.0.1
  MONGO_PORT: 27017
  MONGO_DB_NAME: sefaria
  PYTHONDONTWRITEBYTECODE: 1

jobs:

  prep:
    name: Compute timestamp
    runs-on: [self-hosted, Linux, X64]
    outputs:
      stamp: ${{ steps.ts.outputs.stamp }}
    steps:
      - name: Compute timestamp
        id: ts
        run: |
          TZ="${TZ_NAME}" date '+%Y-%m-%d_%H-%M' > ts.txt
          echo "stamp=$(cat ts.txt)" >> $GITHUB_OUTPUT


  export:
    name: Run export_all_merged
    needs: prep
    runs-on: [self-hosted, Linux, X64]

    env:
      TS_STAMP: ${{ needs.prep.outputs.stamp }}
      SEFARIA_EXPORT_BASE: ${{ github.workspace }}/staging
      SEFARIA_EXPORT_PATH: ${{ github.workspace }}/staging

    steps:

      # ---------------------------------------------------------
      # Checkout only .github
      # ---------------------------------------------------------
      - name: Checkout .github only
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main
          sparse-checkout: |
            .github
          sparse-checkout-cone-mode: false

      # ---------------------------------------------------------
      # Install system dependencies (with sudo)
      # ---------------------------------------------------------
      - name: Install system packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            python3 python3-pip python3-dev \
            build-essential \
            libre2-dev \
            pybind11-dev \
            cmake \
            ninja-build \
            libpq-dev \
            pkg-config \
            aria2 \
            rsync \
            wget curl git ca-certificates

      # ---------------------------------------------------------
      # Install MongoDB Database Tools
      # ---------------------------------------------------------
      - name: Install MongoDB Tools
        run: |
          TOOLS="100.9.4"
          wget -q https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-${TOOLS}.tgz
          tar -xzf mongodb-database-tools-ubuntu2204-x86_64-${TOOLS}.tgz
          sudo mv mongodb-database-tools-ubuntu2204-x86_64-${TOOLS}/bin/* /usr/local/bin/
          rm -rf mongodb-database-tools*

      # ---------------------------------------------------------
      # Clone Sefaria project
      # ---------------------------------------------------------
      - name: Clone Sefaria repo
        run: |
          git clone --depth 1 https://github.com/Sefaria/Sefaria-Project.git

      # ---------------------------------------------------------
      # Fix requirements (ensure psycopg2, google-re2 compile)
      # ---------------------------------------------------------
      - name: Clean requirements for system build
        working-directory: Sefaria-Project
        run: |
          # Ensure psycopg2 is used (not psycopg2-binary)
          sed -i 's/psycopg2-binary/psycopg2/g' requirements.txt || true
          # Ensure google-re2 is not removed
          echo "✅ requirements prepared for local build"

      # ---------------------------------------------------------
      # Install Python dependencies
      # ---------------------------------------------------------
      - name: Install Python dependencies
        working-directory: Sefaria-Project
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install --no-cache-dir -r requirements.txt

      # ---------------------------------------------------------
      # Start MongoDB via Docker
      # ---------------------------------------------------------
      - name: Start MongoDB (Docker)
        run: |
          docker rm -f sefaria-mongo >/dev/null 2>&1 || true
          docker run -d --name sefaria-mongo -p 27017:27017 mongo:6.0

      - name: Wait for MongoDB
        run: |
          for i in {1..60}; do
            if (echo > /dev/tcp/127.0.0.1/27017) >/dev/null 2>&1; then
              echo "✅ MongoDB ready"
              exit 0
            fi
            echo "⏳ Waiting MongoDB…"
            sleep 2
          done
          exit 1

      # ---------------------------------------------------------
      # Download Mongo dump
      # ---------------------------------------------------------
      - name: Download dump_small
        run: |
          mkdir -p mongo_dump
          wget -O dump_small.tar.gz https://storage.googleapis.com/sefaria-mongo-backup/dump_small.tar.gz
          tar -xzf dump_small.tar.gz -C mongo_dump
          rm dump_small.tar.gz

      - name: Normalize dump
        run: |
          mkdir -p mongo_dump_pkg
          if [ -d mongo_dump/dump/sefaria ]; then
            cp -a mongo_dump/dump/sefaria mongo_dump_pkg/
          else
            cp -a mongo_dump/sefaria mongo_dump_pkg/
          fi

      # ---------------------------------------------------------
      # Restore DB
      # ---------------------------------------------------------
      - name: Restore DB
        run: |
          mongorestore --drop --db sefaria mongo_dump_pkg/sefaria

      - name: Ensure history collection
        run: |
          python3 - <<'PY'
          from pymongo import MongoClient
          c = MongoClient("mongodb://127.0.0.1:27017")
          db = c["sefaria"]
          try: db.create_collection("history")
          except: pass
          print("✅ history collection ok")
          PY

      # ---------------------------------------------------------
      # Configure local_settings.py
      # ---------------------------------------------------------
      - name: Configure local_settings.py
        working-directory: Sefaria-Project/sefaria
        run: |
          cp local_settings_example.py local_settings.py
          python3 - <<'PY'
          import os,re
          p="local_settings.py"
          s=open(p).read()
          s=re.sub(r"SEFARIA_EXPORT_PATH\s*=.*", f'SEFARIA_EXPORT_PATH = r"{os.environ["SEFARIA_EXPORT_PATH"]}"', s)
          s=re.sub(r"MONGO_HOST\s*=.*", 'MONGO_HOST = "127.0.0.1"', s)
          s=re.sub(r"MONGO_PORT\s*=.*", 'MONGO_PORT = 27017', s)
          s=re.sub(r"MONGO_DB_NAME\s*=.*", 'MONGO_DB_NAME = "sefaria"', s)
          s=re.sub(r"SEFARIA_DB\s*=.*", 'SEFARIA_DB = "sefaria"', s)
          open(p,"w").write(s)
          PY

      # ---------------------------------------------------------
      # Run export_all_merged
      # ---------------------------------------------------------
      - name: Run export_all_merged
        env:
          PYTHONPATH: ${{ github.workspace }}/Sefaria-Project
        run: |
          mkdir -p "$SEFARIA_EXPORT_PATH/export_all_merged"
          python3 - <<'PY'
          import os,sys,django
          sys.path.insert(0, os.path.abspath("Sefaria-Project"))
          os.environ.setdefault("DJANGO_SETTINGS_MODULE","sefaria.settings")
          django.setup()
          from sefaria import export as ex
          ex.export_all_merged()
          print("✅ export_all_merged completed")
          PY

      # ---------------------------------------------------------
      # Push branch
      # ---------------------------------------------------------
      - name: Push export branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${TS_STAMP}"
          OUT="$SEFARIA_EXPORT_PATH/export_all_merged"

          TMP="$RUNNER_TEMP/pushrepo"
          rm -rf "$TMP"
          mkdir -p "$TMP"

          git -C "$TMP" init
          git -C "$TMP" config user.name "github-actions[bot]"
          git -C "$TMP" config user.email "github-actions[bot]@users.noreply.github.com"
          git -C "$TMP" remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          git -C "$TMP" checkout --orphan "$BRANCH"

          mkdir -p "$TMP/.github"
          cp -a "$GITHUB_WORKSPACE/.github/." "$TMP/.github/"

          cp -a "$OUT/." "$TMP/"

          git -C "$TMP" add -A
          git -C "$TMP" commit -m "Export at ${TS_STAMP}"
          git -C "$TMP" push --force origin HEAD:"$BRANCH"

          echo "✅ Branch pushed: $BRANCH"

      # ---------------------------------------------------------
      # Cleanup
      # ---------------------------------------------------------
      - name: Cleanup
        if: always()
        run: |
          docker rm -f sefaria-mongo >/dev/null 2>&1 || true
          rm -rf mongo_dump mongo_dump_pkg Sefaria-Project staging || true
          echo "✅ cleanup done"
