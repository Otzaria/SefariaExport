name: Python 3.9 + MongoDB + Sefaria Export (Matrix, zstd --ultra -22 -T0 ‚Ä¢ self-hosted)

on:
  workflow_dispatch:
    inputs:
      timezone:
        description: "Timezone for timestamp/tag (IANA name)"
        required: false
        default: "Asia/Jerusalem"

permissions:
  contents: write

env:
  TZ_NAME: ${{ inputs.timezone || 'Asia/Jerusalem' }}
  DJANGO_SETTINGS_MODULE: sefaria.settings
  MONGO_HOST: 127.0.0.1
  MONGO_PORT: 27017
  MONGO_DB_NAME: sefaria

jobs:
  prep:
    name: Compute timestamp
    runs-on: [self-hosted, Linux, X64]
    outputs:
      stamp: ${{ steps.ts.outputs.stamp }}
    steps:
      - name: Compute release timestamp
        id: ts
        run: |
          TZ="${TZ_NAME}" date '+%Y-%m-%d_%H-%M' > ts.txt
          echo "stamp=$(cat ts.txt)" >> "$GITHUB_OUTPUT"

  fetch_dump:
    name: Download & package Mongo dump (once)
    runs-on: [self-hosted, Linux, X64]
    needs: prep
    steps:
      - name: Pre-clean docker (optional)
        continue-on-error: true
        run: |
          if command -v docker >/dev/null 2>&1; then
            docker ps -aq | xargs -r docker stop
            docker ps -aq | xargs -r docker rm -f
            docker system prune -af || true
          fi

      - name: Install helpers (aria2, tar, certs)
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y aria2 ca-certificates tar
          fi

      - name: Download small Mongo dump (via aria2c)
        run: |
          mkdir -p mongo_dump
          aria2c -x 16 -s 16 -k 1M -o dump_small.tar.gz "https://storage.googleapis.com/sefaria-mongo-backup/dump_small.tar.gz"
          tar -xzf dump_small.tar.gz -C mongo_dump
          echo "Dump tree:"
          find mongo_dump -maxdepth 3 | sed -e 's/^/  /'

      - name: Normalize layout to mongo_dump_pkg/sefaria
        run: |
          mkdir -p mongo_dump_pkg
          if [ -d mongo_dump/dump/sefaria ]; then
            cp -a mongo_dump/dump/sefaria mongo_dump_pkg/
          elif [ -d mongo_dump/sefaria ]; then
            cp -a mongo_dump/sefaria mongo_dump_pkg/
          else
            echo "‚ùå Could not find 'sefaria' folder in dump"; exit 1
          fi
          echo "Packaged tree:"
          find mongo_dump_pkg -maxdepth 2 | sed -e 's/^/  /'

      - name: Upload dump artifact
        uses: actions/upload-artifact@v4
        with:
          name: mongo-dump-sefaria
          path: mongo_dump_pkg

  export:
    name: Run ${{ matrix.export_function }}
    runs-on: [self-hosted, Linux, X64]
    needs: [prep, fetch_dump]

    strategy:
      fail-fast: false
      matrix:
        export_function: [export_all_merged, export_links, export_schemas, export_toc]

    # Use Docker-based services on the self-hosted runner (Docker must be installed & running)
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    env:
      EXPORT_FUNCTION: ${{ matrix.export_function }}
      TS_STAMP: ${{ needs.prep.outputs.stamp }}
      SEFARIA_EXPORT_BASE: ${{ github.workspace }}/exports
      SEFARIA_EXPORT_PATH: ${{ github.workspace }}/exports/${{ matrix.export_function }}

    steps:
      - name: Pre-clean docker (optional)
        continue-on-error: true
        run: |
          if command -v docker >/devnull 2>&1; then
            docker ps -aq | xargs -r docker stop
            docker ps -aq | xargs -r docker rm -f
            docker system prune -af || true
          fi

      - name: Checkout (this repository)
        uses: actions/checkout@v4

      - name: Show runner & disk
        run: |
          uname -a || true
          df -h || true
          whoami || true
          id || true

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Verify Python & pip versions
        run: |
          python -V
          which python
          pip -V

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install system helpers (wget, zstd, tar, nc)
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y wget ca-certificates zstd tar netcat-openbsd
          fi

      - name: Install MongoDB Database Tools (mongorestore)
        run: |
          TOOLS_VER="100.9.4"
          if ! command -v mongorestore >/dev/null 2>&1; then
            wget -q https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz
            tar -xzf mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz
            sudo mv mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}/bin/* /usr/local/bin/
          fi
          mongorestore --version

      - name: Clone Sefaria-Project (main repo, contains sefaria/export.py)
        run: |
          git clone --depth 1 https://github.com/Sefaria/Sefaria-Project.git
          ls -la Sefaria-Project

      - name: Install system build deps for google-re2
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y libre2-dev pybind11-dev build-essential cmake ninja-build
          fi

      - name: Pin google-re2==1.0 for compatibility
        working-directory: Sefaria-Project
        run: |
          echo "google-re2==1.0" > constraints-ci.txt

      - name: Install Python deps with constraints
        id: pip_install
        continue-on-error: true
        working-directory: Sefaria-Project
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt -c constraints-ci.txt

      - name: Fallback install built-google-re2 if needed
        if: ${{ steps.pip_install.outcome == 'failure' }}
        working-directory: Sefaria-Project
        run: |
          echo "Primary install failed ‚Äî trying built-google-re2 fallback..."
          grep -viE '^\s*google-re2' requirements.txt > req-no-re2.txt || true
          pip install -r req-no-re2.txt
          pip install built-google-re2

      - name: Create minimal local_settings.py for CI (sets SEFARIA_DB!)
        working-directory: Sefaria-Project/sefaria
        run: |
          mkdir -p "$SEFARIA_EXPORT_PATH"
          cp local_settings_example.py local_settings.py
          python - <<'PY'
          import os, re
          p = "local_settings.py"
          with open(p, "r", encoding="utf-8") as f:
              s = f.read()
          s = re.sub(r"SEFARIA_EXPORT_PATH\s*=.*", f'SEFARIA_EXPORT_PATH = r"{os.environ["SEFARIA_EXPORT_PATH"]}"', s)
          s = re.sub(r"MONGO_HOST\s*=.*", f'MONGO_HOST = "{os.environ["MONGO_HOST"]}"', s)
          s = re.sub(r"MONGO_PORT\s*=.*", f'MONGO_PORT = {int(os.environ["MONGO_PORT"])}', s)
          s = re.sub(r"MONGO_DB_NAME\s*=.*", f'MONGO_DB_NAME = "{os.environ["MONGO_DB_NAME"]}"', s)
          if re.search(r"SEFARIA_DB\s*=", s):
              s = re.sub(r"SEFARIA_DB\s*=.*", 'SEFARIA_DB = "sefaria"', s)
          else:
              s += '\nSEFARIA_DB = "sefaria"\n'
          with open(p, "w", encoding="utf-8") as f:
              f.write(s)
          print("‚úÖ local_settings.py configured (SEFARIA_DB=sefaria)")
          PY

      - name: Wait for MongoDB TCP (safety)
        run: |
          for i in {1..60}; do
            if nc -z 127.0.0.1 27017; then
              echo "‚úÖ MongoDB TCP port is reachable"; break
            fi
            echo "‚è≥ Waiting for MongoDB TCP..."; sleep 2
          done

      - name: Download dump artifact (once fetched)
        uses: actions/download-artifact@v4
        with:
          name: mongo-dump-sefaria
          path: mongo_dump_pkg

      - name: Restore database from artifact dump + create empty history
        run: |
          if [ ! -d mongo_dump_pkg/sefaria ]; then
            echo "‚ùå mongo_dump_pkg/sefaria not found"; exit 1
          fi
          mongorestore --host 127.0.0.1 --port 27017 --drop --db sefaria "mongo_dump_pkg/sefaria"
          python - <<'PY'
          from pymongo import MongoClient, errors
          client = MongoClient("mongodb://127.0.0.1:27017")
          db = client["sefaria"]
          try:
              db.create_collection("history")
              print("Created empty 'history' collection.")
          except errors.CollectionInvalid:
              print("'history' collection already exists.")
          PY
          echo "‚úÖ Mongo restore complete."

      - name: Pre-clean big SDKs/caches (free disk)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo rm -rf ~/.cache/pip || true
          df -h

      - name: Run export function ${{ env.EXPORT_FUNCTION }}
        working-directory: Sefaria-Project
        env:
          PYTHONPATH: ${{ github.workspace }}/Sefaria-Project
        run: |
          mkdir -p "$SEFARIA_EXPORT_PATH"
          echo "Running export: $EXPORT_FUNCTION"
          python - <<'PY'
          import os, sys, django
          sys.path.insert(0, os.path.abspath("."))
          os.environ.setdefault("DJANGO_SETTINGS_MODULE", "sefaria.settings")
          os.environ.setdefault("SEFARIA_EXPORT_PATH", os.environ.get("SEFARIA_EXPORT_PATH"))
          django.setup()
          from sefaria import export as ex
          fn = os.environ.get("EXPORT_FUNCTION", "").strip()
          allowed = {
            "export_all_merged": ex.export_all_merged,
            "export_links": ex.export_links,
            "export_schemas": ex.export_schemas,
            "export_toc": ex.export_toc,
          }
          if fn not in allowed:
            raise SystemExit(f"Unknown/disabled export function: {fn}")
          allowed[fn]()
          print(f"‚úÖ {fn} completed successfully.")
          PY

      - name: Cleanup MongoDB database after export (free space)
        run: |
          echo "üóëÔ∏è Dropping MongoDB database 'sefaria' to free up space..."
          mongosh --quiet --eval 'db.getSiblingDB("sefaria").dropDatabase(); print("‚úÖ Database dropped.")' || \
          python - <<'PY'
          from pymongo import MongoClient
          client = MongoClient("mongodb://127.0.0.1:27017")
          client.drop_database("sefaria")
          print("‚úÖ Database dropped via PyMongo fallback.")
          PY
          echo "Disk usage after cleanup:"
          df -h

      - name: Pack export as tar.zst (--ultra -22 -T0)
        run: |
          cd "$SEFARIA_EXPORT_BASE"
          TARBALL="sefaria-${{ matrix.export_function }}-${TS_STAMP}.tar.zst"
          tar -cf - "${{ matrix.export_function }}" | zstd --ultra -22 -T0 -o "${TARBALL}"
          echo "PKG_DIR=$(pwd)" >> "$GITHUB_ENV"
          echo "TARBALL=${TARBALL}" >> "$GITHUB_ENV"
          ls -lh "${TARBALL}" || true

      - name: Upload tar.zst as artifact (internal)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.export_function }}-${{ env.TS_STAMP }}
          path: ${{ env.PKG_DIR }}/${{ env.TARBALL }}

      - name: Post-clean docker (optional)
        continue-on-error: true
        run: |
          if command -v docker >/dev/null 2>&1; then
            docker ps -aq | xargs -r docker stop
            docker ps -aq | xargs -r docker rm -f
            docker system prune -af || true
          fi

  release:
    name: Create GitHub Release (upload per-export tar.zst)
    runs-on: [self-hosted, Linux, X64]
    needs: [prep, export]
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all per-export artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloads

      - name: Ensure gh cli present
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            if command -v apt-get >/dev/null 2>&1; then
              echo "Installing GitHub CLI..."
              sudo apt-get update -y
              sudo apt-get install -y curl ca-certificates
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
                | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
              sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
                | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
              sudo apt-get update -y && sudo apt-get install -y gh
            else
              echo "‚ùå gh not found and automatic install not supported on this distro"; exit 1
            fi
          fi
          gh --version

      - name: Create GitHub Release (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG='${{ needs.prep.outputs.stamp }}'
          TITLE='${{ needs.prep.outputs.stamp }}'
          NOTES=$'Automated Sefaria exports (zstd --ultra -22 -T0).\n\nIncluded per-export archives:\n  - export_all_merged\n  - export_links\n  - export_schemas\n  - export_toc\n\nRestore any archive:\n  tar --zstd -xf <name>.tar.zst'
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" -t "$TITLE" -n "$NOTES"

      - name: Upload per-export .tar.zst files with retry
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail
          TAG='${{ needs.prep.outputs.stamp }}'
          mapfile -t FILES < <(find downloads -type f -name '*.tar.zst' | sort -V)
          for f in "${FILES[@]}"; do
            echo "Uploading: $f"
            for attempt in {1..6}; do
              if gh release upload "$TAG" "$f" --clobber; then
                echo "‚úÖ Uploaded: $f"
                break
              fi
              sleep $((2**attempt))
              echo "Retry $attempt for $f..."
              if [[ $attempt -eq 6 ]]; then
                echo "‚ùå Failed to upload $f after retries"
                exit 1
              fi
            done
          done

      - name: Final docker prune (optional)
        continue-on-error: true
        run: |
          if command -v docker >/dev/null 2>&1; then
            docker ps -aq | xargs -r docker stop
            docker ps -aq | xargs -r docker rm -f
            docker system prune -af || true
          fi
